<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music 360 Probe | SnowWolf HUB</title>

<!-- ğŸ”’ å›ºå®šç›¸å®¹ç‰ˆæœ¬ï¼šthree r105 + panolens 0.12.0 -->
<script src="https://cdn.jsdelivr.net/npm/three@0.105.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/panolens@0.12.0/build/panolens.min.js"></script>

<style>
  :root{--ui:#0e1a2b;--ink:#cfe1ff;--accent:#9ad6ff}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;font-family:"Noto Sans TC","PingFang TC",sans-serif;color:var(--ink)}
  #app{position:fixed;inset:0;background:#000}
  .toolbar{position:fixed;left:12px;top:12px;display:flex;gap:10px;z-index:10}
  .pill{background:var(--ui);color:var(--ink);border:1px solid #2a4365;border-radius:999px;padding:7px 12px;font-size:13px;cursor:pointer}
  .pill:active{transform:translateY(1px)}
  .status{position:fixed;right:12px;top:12px;display:flex;gap:10px;z-index:10}
  .badge{background:#091323;color:#8fb8ff;border:1px solid #1f3357;border-radius:10px;padding:6px 10px;font-size:12px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0b1628;border:1px solid #21406c;color:#dff2ff;padding:10px 14px;border-radius:12px;display:none;z-index:20}
  .hint{position:fixed;left:10px;bottom:10px;color:#9bb2d4;font-size:12px;opacity:.8}
  /* æ‹–æ‹‰è¦†è“‹æç¤º */
  .drop{position:fixed;inset:0;border:2px dashed #66a3ff55;border-radius:14px;display:none;place-items:center;color:#a7c6ff;background:#0a142466;z-index:15}
  .drop.show{display:grid}
</style>
</head>
<body>
<div id="app"></div>

<!-- UI -->
<div class="toolbar">
  <button id="btnOpen" class="pill">ğŸ“ é–‹å•Ÿå½±åƒ</button>
  <button id="btnAuto" class="pill" data-on="1">ğŸ”„ è‡ªå‹•æ—‹è½‰ï¼šé–‹</button>
  <button id="btnReset" class="pill">ğŸ¯ é‡ç½®è¦–è§’</button>
  <button id="btnFS" class="pill">â›¶ å…¨è¢å¹•</button>
  <button id="btnVR" class="pill">ğŸ•¶ï¸ VR / Cardboard</button>
</div>
<div class="status">
  <div id="badgeres" class="badge">è§£æåº¦ï¼šâ€”</div>
  <div id="badgestate" class="badge">ç‹€æ…‹ï¼šå¾…æ©Ÿ</div>
  <div id="badgefile" class="badge">æª”æ¡ˆä½ç½®ï¼šâ€”</div>
</div>
<div id="toast" class="toast"></div>
<div id="drop" class="drop"><div style="font-size:18px">æŠŠ 2:1 equirectangular JPG æ‹–é€²ä¾†å³å¯è¼‰å…¥</div></div>
<div class="hint">æç¤ºï¼šæ‹–æ‹‰ 2:1 equirectangular JPG åˆ°ç•«é¢ä¹Ÿèƒ½è¼‰å…¥ã€‚</div>

<input id="file" type="file" accept="image/jpeg,image/jpg" hidden />

<script>
(function(){
  const $ = (q)=>document.querySelector(q);
  const app = $('#app');
  const toastEl = $('#toast');
  const drop = $('#drop');

  // ---- Viewerï¼ˆé–å®šç©©å®šåƒæ•¸ï¼‰----
  const viewer = new PANOLENS.Viewer({
    container: app,
    controlBar: false,               // è‡ªå·±åš UI
    autoHideInfospot: true,
    output: 'console',
    cameraFov: 75,
    passiveRendering: false
  });

  // æ–¹ä¾¿æ§åˆ¶æ—‹è½‰
  const controls = viewer.OrbitControls;
  controls.autoRotate = true;
  controls.autoRotateSpeed = 0.3;

  let pano = null;
  let currentURL = '';

  function showToast(msg, ms=1400){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(()=>toastEl.style.display='none', ms);
  }
  function setBadges({res, state, file}){
    if(res) $('#badgeres').textContent = 'è§£æåº¦ï¼š' + res;
    if(state) $('#badgestate').textContent = 'ç‹€æ…‹ï¼š' + state;
    if(file) $('#badgefile').textContent = 'æª”æ¡ˆä½ç½®ï¼š' + file;
  }

  // ---- è¼‰å…¥ Panorama ----
  async function loadPano(url, fileNameDisplay){
    setBadges({state:'è¼‰å…¥ä¸­â€¦', file:url || fileNameDisplay || 'â€”'});
    try{
      // å…ˆæ¢æ¸¬å°ºå¯¸
      const dim = await probeImage(url);
      const ratio = (dim.width/dim.height).toFixed(3);
      setBadges({res: dim.width+'Ã—'+dim.height+'ï¼ˆæ¯”ï¼š'+ratio+'ï¼‰'});

      // æ¯”ä¾‹æç¤ºï¼ˆä¸é˜»æ“‹ï¼‰
      if(Math.abs(dim.width/dim.height - 2) > 0.1){
        showToast('âš ï¸ é€™å¼µä¸æ˜¯æ¥è¿‘ 2:1ï¼Œä»å˜—è©¦é¡¯ç¤º', 1800);
      }

      // é‡‹æ”¾èˆŠ pano
      if(pano){
        viewer.remove(pano);
        pano.dispose && pano.dispose();
        pano = null;
      }

      pano = new PANOLENS.ImagePanorama(url);
      pano.addEventListener('progress', e => {
        setBadges({state: 'è¼‰å…¥ä¸­â€¦ '+ Math.round(e.progress*100)+'%'});
      });
      pano.addEventListener('enter-fade-start', ()=>setBadges({state:'é¡¯ç¤ºä¸­'}));
      pano.addEventListener('error', ()=>setBadges({state:'âŒ è¼‰å…¥å¤±æ•—'}));

      viewer.add(pano);
      viewer.setPanorama(pano);         // åˆ‡æ›éå»
      resetView();                       // åˆå§‹è¦–è§’
      currentURL = url;
    }catch(err){
      console.error(err);
      setBadges({state:'âŒ éŒ¯èª¤'});
      showToast('è¼‰å…¥å¤±æ•—ï¼š'+(err.message||err), 2000);
    }
  }

  // åœ–ç‰‡å°ºå¯¸åµæ¸¬
  function probeImage(url){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>resolve({width: img.naturalWidth, height: img.naturalHeight});
      img.onerror = ()=>reject(new Error('è®€å–åœ–ç‰‡å¤±æ•—'));
      img.src = url + ((url.includes('?')?'&':'?')+'_ts=') + Date.now(); // é˜²å¿«å–
    });
  }

  function resetView(){
    // å›åˆ°ä¸­å¿ƒ + å›ºå®š FOV
    const v = new THREE.Vector3(0,0,0);
    viewer.tweenControlCenter(v, 0);     // ç«‹å³
    viewer.camera.fov = 75;
    viewer.camera.updateProjectionMatrix();
  }

  // ---- UI ç¶å®š ----
  $('#btnOpen').onclick = ()=> $('#file').click();

  $('#file').onchange = ()=>{
    const f = $('#file').files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    loadPano(url, f.name);
  };

  $('#btnAuto').onclick = (e)=>{
    controls.autoRotate = !controls.autoRotate;
    e.currentTarget.dataset.on = controls.autoRotate ? '1' : '0';
    e.currentTarget.textContent = (controls.autoRotate ? 'ğŸ”„ è‡ªå‹•æ—‹è½‰ï¼šé–‹' : 'â¹ï¸ è‡ªå‹•æ—‹è½‰ï¼šé—œ');
  };

  $('#btnReset').onclick = ()=> resetView();

  $('#btnFS').onclick = ()=>{
    if(!document.fullscreenElement) app.requestFullscreen().catch(()=>{});
    else document.exitFullscreen();
  };

  $('#btnVR').onclick = ()=>{
    // Panolens æœƒè‡ªå‹•åˆ‡åˆ°ç«‹é«”æ¨¡å¼ï¼ˆCardboardï¼‰
    viewer.enableEffect(PANOLENS.Modes.CARDBOARD);
    showToast('å·²åˆ‡æ› VR / Cardboard æ¨¡å¼');
  };

  // ---- æ‹–æ‹‰æª”æ¡ˆ ----
  window.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('show')});
  window.addEventListener('dragleave',()=>drop.classList.remove('show'));
  window.addEventListener('drop',(e)=>{
    e.preventDefault(); drop.classList.remove('show');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(!f) return;
    if(!/image\/jpe?g/i.test(f.type)){ showToast('åªæ¥å— JPG'); return;}
    const url = URL.createObjectURL(f);
    loadPano(url, f.name);
  });

  // ---- å•Ÿå‹•ï¼šè®€ URL åƒæ•¸æˆ–é è¨­ ----
  (function init(){
    const params = new URLSearchParams(location.search);
    const src = params.get('src') || 'img/360/school_music_360.jpg';
    loadPano(src);
  })();
})();
</script>
</body>
</html>
