<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è˜­è–©çˆ¾æ ¡åœ’å»£å ´ Courtyard | Snowwolf HUB</title>
<link rel="preload" as="audio" href="audio/courtyard_theme.mp3">
<link rel="preload" as="audio" href="sfx/click.wav">
<style>
:root{
  --ink:#e7eefb;--muted:#9bb2d4;--chip:#152238;--panel:#0f1726;
  --edge:#223553;--primary:#78a2ff;--accent:#9ad6ff;--radius:18px;
}
*{box-sizing:border-box} html,body{height:100%;margin:0;background:#000;
  font-family:"PingFang TC","Noto Sans TC",sans-serif;color:var(--ink)}
/* èƒŒæ™¯ */
.bg{position:fixed;inset:0;background:url("img/bg/school_courtyard.jpg") center/cover no-repeat;
  filter:brightness(.98) contrast(1.05);transition:filter .6s}
.shade{position:fixed;inset:0;pointer-events:none;
  background:radial-gradient(1200px 800px at 50% 20%,rgba(0,0,0,.08),rgba(0,0,0,.5) 70%)}
/* é£„é›ª Canvas */
#snow, #mist{position:fixed;inset:0;pointer-events:none}
/* ä¸Šæ’å°è¦½èˆ‡ HUD */
.topbar{position:fixed;left:18px;right:18px;top:12px;z-index:10;display:flex;gap:12px;align-items:center}
.chip{background:var(--chip);color:#cfe1ff;border:1px solid var(--edge);
  border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
.spacer{flex:1}
.hud{position:fixed;left:18px;right:18px;top:56px;z-index:9;display:flex;gap:24px;align-items:center}
.badges{display:flex;gap:8px}
.badges .chip{display:flex;align-items:center;gap:6px}
.bars{display:flex;gap:22px}
.bar{width:210px}
.bar label{display:block;font-size:12px;color:#b9c8e6;margin:0 0 4px 2px}
.meter{height:6px;background:#0d1830;border:1px solid #1e2c47;border-radius:999px;overflow:hidden}
.meter span{display:block;height:100%;background:linear-gradient(90deg,#4aa3ff,#9ad6ff)}
/* ä»»å‹™å…¬å‘Šæ¿ */
.board{position:fixed;left:50%;top:58%;transform:translate(-50%,-50%);
  width:min(1100px,92vw);display:grid;grid-template-columns:repeat(3,1fr);gap:14px;z-index:6}
.card{background:linear-gradient(180deg,#0e182bde,#0a1220e6);border:1px solid #1b2b47;border-radius:16px;
  backdrop-filter:blur(8px);padding:14px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
.card h4{margin:0 0 6px 0;font-size:16px}
.card p{margin:6px 0 10px 0;color:#c3d6f7;font-size:13px;min-height:38px}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.tag{font-size:11px;padding:4px 8px;border:1px solid #25426e;border-radius:999px;background:#132744}
.btn{background:#173055;color:#e7f1ff;border:1px solid #27426e;border-radius:12px;padding:8px 12px;
  font-size:13px;cursor:pointer}
.btn[disabled]{opacity:.45;cursor:not-allowed}
/* å°è©±æ¡† */
.dialog{position:fixed;left:18px;right:18px;bottom:18px;z-index:7;
  background:linear-gradient(180deg,#0d1524e6,#0a111ee6);border:1px solid #1a2a44;border-radius:22px;
  padding:18px 22px;display:grid;grid-template-columns:88px 1fr auto;gap:18px;align-items:end}
.avatar img{width:88px;height:88px;border-radius:16px;object-fit:cover;border:1px solid #273a5a}
.line{font-size:18px}
#next{align-self:center}
#returnGame{position:fixed;right:28px;bottom:108px;z-index:8;background:#173055;border:1px solid #2a4b7a;
  border-radius:50%;width:68px;height:68px;display:flex;align-items:center;justify-content:center;
  font-size:26px;box-shadow:0 0 20px #9ad6ff80;cursor:pointer}
/* æµ®å‹•æç¤º */
.toast{position:fixed;right:18px;bottom:18px;background:#0c1a30;border:1px solid #234168;border-radius:12px;
  padding:10px 14px;display:none;z-index:50}
@media (max-width:960px){
  .board{grid-template-columns:1fr}
}
</style>
</head>
<body>
<canvas id="snow"></canvas>
<canvas id="mist"></canvas>
<div class="bg"></div><div class="shade"></div>

<!-- å°è¦½ -->
<div class="topbar">
  <button class="chip" data-jump="school.html">ğŸ« å›åˆ°å­¸æ ¡é¦–é </button>
  <button class="chip" data-jump="wardrobe.html">ğŸ§¥ è¡£æ«ƒ</button>
  <button class="chip" data-jump="bag.html">ğŸ’ é“å…·</button>
  <div class="spacer"></div>
  <div class="badges">
    <div class="chip">ğŸ’° é‡‘å¹£ <b id="coins">0</b></div>
    <button id="bgmBtn" class="chip">BGMï¼šé–‹</button>
  </div>
</div>

<!-- HUD -->
<div class="hud">
  <div class="bars">
    <div class="bar"><label>å‹‡æ°£ Courage</label><div class="meter"><span id="mC" style="width:0%"></span></div></div>
    <div class="bar"><label>åŒç† Empathy</label><div class="meter"><span id="mE" style="width:0%"></span></div></div>
    <div class="bar"><label>çœŸå¯¦ Truth</label><div class="meter"><span id="mT" style="width:0%"></span></div></div>
  </div>
</div>

<!-- ä»»å‹™å…¬å‘Šæ¿ -->
<div class="board" id="board"></div>

<!-- å°è©± -->
<div class="dialog">
  <div class="avatar"><img id="ava" src="img/avatars/system_core.png" alt="avatar"></div>
  <div>
    <div id="who" style="font-weight:700;font-size:18px">ç³»çµ±</div>
    <div id="line" class="line">ã€Œæ­¡è¿ä¾†åˆ°æ ¡åœ’å»£å ´ã€‚å¾å…¬å‘Šæ¿æŒ‘ä¸€å€‹ä»»å‹™é–‹å§‹å§ï¼ã€</div>
  </div>
  <button id="next" class="btn">ä¸‹ä¸€å¥ â–¶</button>
</div>

<!-- å›åˆ°å†’éšª -->
<div id="returnGame" title="å›åˆ°å†’éšª">ğŸ”ï¸</div>

<div id="toast" class="toast"></div>

<audio id="bgm" src="audio/courtyard_theme.mp3" loop></audio>
<audio id="sfx" src="sfx/click.wav" preload="auto"></audio>

<script>
// å¿«æ·
const $ = (q)=>document.querySelector(q);
const SFX = $('#sfx');
const toast=(t)=>{const n=$('#toast');n.textContent=t;n.style.display='block';setTimeout(()=>n.style.display='none',1200);};
function sfx(){try{SFX.currentTime=0;SFX.play();}catch{}}

// ç‹€æ…‹ï¼ˆæ²¿ç”¨ school.html ç›¸åŒ keyï¼‰
const state={
  coins: Number(localStorage.getItem('coins')||140),
  C: +localStorage.getItem('stat_C')||24,
  E: +localStorage.getItem('stat_E')||18,
  T: +localStorage.getItem('stat_T')||12,
  bag: JSON.parse(localStorage.getItem('bag')||'[]')
};
const mm={C:$('#mC'),E:$('#mE'),T:$('#mT')};
function syncHUD(){
  $('#coins').textContent = state.coins;
  mm.C.style.width = Math.min(state.C,100)+'%';
  mm.E.style.width = Math.min(state.E,100)+'%';
  mm.T.style.width = Math.min(state.T,100)+'%';
  localStorage.setItem('coins',state.coins);
  localStorage.setItem('stat_C',state.C);
  localStorage.setItem('stat_E',state.E);
  localStorage.setItem('stat_T',state.T);
  localStorage.setItem('bag',JSON.stringify(state.bag));
}
syncHUD();

// å°è©±
const dialogScripts=[
  {n:'æµ·ç‘Ÿ',a:'img/avatars/heather.png',t:'ã€Œä½ˆå‘Šæ¬„ä»Šå¤©å¥½å¤šä»»å‹™ï¼é¸ä¸€å€‹æœ€æƒ³æŒ‘æˆ°çš„å§ã€‚ã€'},
  {n:'è¿ªæ©',a:'img/avatars/dean.png',t:'ã€Œæˆ‘æŠ•å‹‡æ°£è©¦ç…‰ä¸€ç¥¨ï¼Œè·‘æ“å ´ä¸‰åœˆé‚£ç¨®ã€‚ã€'},
  {n:'è‰¾è–©å…‹',a:'img/avatars/isaac.png',t:'ã€Œä¹Ÿå¯ä»¥å»å¹«åœ–æ›¸é¤¨æ•´ç†ã€æœƒè‡ªå·±é£›çš„æ›¸ã€ã€‚ã€'},
  {n:'ç³»çµ±',a:'img/avatars/system_core.png',t:'æç¤ºï¼šå®Œæˆä»»å‹™æœƒå¾—åˆ°é‡‘å¹£ã€é“å…·æˆ–æå‡å‹‡æ°£ï¼åŒç†ï¼çœŸå¯¦ã€‚'}
];
let dIdx=0;
function showLine(o){$('#who').textContent=o.n;$('#line').textContent=o.t;$('#ava').src=o.a||'img/avatars/system_core.png';}
$('#next').onclick=()=>{sfx();showLine(dialogScripts[dIdx++%dialogScripts.length]);};
showLine(dialogScripts[0]);

// ä»»å‹™è³‡æ–™ï¼ˆå®Œæˆç‹€æ…‹ä¿å­˜åœ¨ localStorageï¼‰
const QUEST_KEY='quests_courtyard_v1';
let QUEST_STATE = JSON.parse(localStorage.getItem(QUEST_KEY)||'{}');

const QUESTS=[
  {
    id:'q_run',
    title:'å‹‡æ°£è©¦ç…‰ï¼šæ™¨é–“ä¸‰åœˆ',
    desc:'åœ¨æ“å ´å®Œæˆä¸‰åœˆç·´ç¿’ï¼Œå …æŒåˆ°æœ€å¾Œã€‚',
    tags:['å‹‡æ°£ +3','é‡‘å¹£ +10'],
    reward:{C:3,coins:10}
  },
  {
    id:'q_books',
    title:'åœ–æ›¸é¤¨ï¼šå®‰æ’«é£›æ›¸',
    desc:'å”åŠ©é¤¨å“¡æŠŠæ¼‚æµ®æ›¸ç±å°å›æ›¸æ¶ã€‚',
    tags:['åŒç† +2','çœŸå¯¦ +1','é“å…·ï¼šæ™‚é–“æ›¸ç±¤'],
    reward:{E:2,T:1,item:'æ™‚é–“æ›¸ç±¤'}
  },
  {
    id:'q_music',
    title:'éŸ³æ¨‚æ•™å®¤ï¼šåˆå¥æŒ‘æˆ°',
    desc:'å’ŒåŒå­¸å®Œæˆä¸€æ®µå››æ‰‹è¯å½ˆã€‚',
    tags:['åŒç† +1','å‹‡æ°£ +1','é‡‘å¹£ +8'],
    reward:{E:1,C:1,coins:8}
  },
  {
    id:'q_principal',
    title:'æ ¡é•·å®¤ï¼šèª å¯¦å ±å‘Š',
    desc:'å¦‚å¯¦å›å ±ä»Šå¤©çš„çŠ¯éŒ¯ä¸¦æå‡ºæ”¹é€²ã€‚',
    tags:['çœŸå¯¦ +3'],
    reward:{T:3}
  },
  {
    id:'q_art',
    title:'ç¾è¡“æ•™å®¤ï¼šå®Œæˆé›ªç‹¼é€Ÿå¯«',
    desc:'æŠŠå…§å¿ƒçš„å…‰ç•«é€²ç•«å¸ƒã€‚',
    tags:['åŒç† +2','é“å…·ï¼šç•«ç­†'],
    reward:{E:2,item:'ç•«ç­†'}
  },
  {
    id:'q_clean',
    title:'æ ¡åœ’å¿—å·¥ï¼šå»£å ´æ¸…æƒ',
    desc:'ä¸€èµ·æŠŠå»£å ´æ‰“æƒä¹¾æ·¨ï¼Œè®“é¢¨æ™¯ç™¼å…‰ã€‚',
    tags:['å‹‡æ°£ +1','åŒç† +1','é‡‘å¹£ +6'],
    reward:{C:1,E:1,coins:6}
  }
];

function renderBoard(){
  const box=$('#board'); box.innerHTML='';
  QUESTS.forEach(q=>{
    const done = !!QUEST_STATE[q.id];
    const el=document.createElement('div');
    el.className='card';
    el.innerHTML=`
      <h4>${q.title} ${done? 'âœ…':''}</h4>
      <p>${q.desc}</p>
      <div class="tags">${q.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-act="goto" data-id="${q.id}">å‰å¾€åœ°é»</button>
        <button class="btn" data-act="claim" data-id="${q.id}" ${done?'disabled':''}>å®Œæˆä»»å‹™</button>
      </div>`;
    box.appendChild(el);
  });
}
renderBoard();

$('#board').addEventListener('click',e=>{
  const b=e.target.closest('button'); if(!b) return; sfx();
  const id=b.dataset.id; const q=QUESTS.find(x=>x.id===id);
  if(b.dataset.act==='goto'){
    // å°å‘å­¸æ ¡å°æ‡‰å ´æ™¯ï¼ˆç”¨ä½ çš„ school.html é€²å…¥é»ï¼‰
    localStorage.setItem('school_target_from_map',id); // çµ¦ school.html åˆ¤æ–·è¦è‡ªå‹•è·³å“ªä¸€é–“
    location.href='school.html';
  }else if(b.dataset.act==='claim'){
    if(QUEST_STATE[id]){toast('å·²å®Œæˆéæ­¤ä»»å‹™');return;}
    QUEST_STATE[id]=true;
    const r=q.reward;
    state.C += r.C||0; state.E += r.E||0; state.T += r.T||0;
    state.coins += r.coins||0;
    if(r.item){ state.bag.push(r.item); toast(`ç²å¾—é“å…·ï¼š${r.item}`); }
    syncHUD(); localStorage.setItem(QUEST_KEY,JSON.stringify(QUEST_STATE));
    renderBoard();
    showLine({n:'ç³»çµ±',a:'img/avatars/system_core.png',t:`ä»»å‹™å®Œæˆï¼å‹‡æ°£+${r.C||0} åŒç†+${r.E||0} çœŸå¯¦+${r.T||0} é‡‘å¹£+${r.coins||0}`});
  }
});

// é€£çµ
document.querySelectorAll('[data-jump]').forEach(b=>b.addEventListener('click',()=>{sfx();location.href=b.dataset.jump;}));
$('#returnGame').onclick=()=>{sfx();location.href='mission_snow_temple.html';};

// BGM
const bgm=$('#bgm');
function playBGM(){try{bgm.volume=.8;bgm.play();}catch{}}
playBGM();
$('#bgmBtn').onclick=()=>{sfx(); if(bgm.paused){playBGM();$('#bgmBtn').textContent='BGMï¼šé–‹';} else {bgm.pause();$('#bgmBtn').textContent='BGMï¼šé—œ';}};

// é£„é›ª
(function snow(){
  const c=$('#snow'),ctx=c.getContext('2d');
  function rs(){c.width=innerWidth;c.height=innerHeight}
  addEventListener('resize',rs); rs();
  const flakes=Array.from({length:180},()=>({
    x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*2+0.8,v:Math.random()*0.6+0.3
  }));
  (function loop(){
    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle='rgba(230,245,255,.85)';
    flakes.forEach(f=>{
      f.y+=f.v; f.x+=Math.sin(f.y*0.01)*0.2;
      if(f.y>c.height){f.y=-10;f.x=Math.random()*c.width}
      ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(loop);
  })();
})();

// è–„éœ§
(function mist(){
  const c=$('#mist'),ctx=c.getContext('2d');
  function rs(){c.width=innerWidth;c.height=innerHeight}
  addEventListener('resize',rs); rs();
  let t=0;
  (function loop(){
    t+=0.003; ctx.clearRect(0,0,c.width,c.height);
    for(let i=0;i<3;i++){
      const g=ctx.createRadialGradient(
        (Math.sin(t+i)*0.3+0.5)*c.width,
        (Math.cos(t*0.8+i)*0.2+0.8)*c.height,
        0,
        (Math.sin(t+i)*0.3+0.5)*c.width,
        (Math.cos(t*0.8+i)*0.2+0.8)*c.height,
        Math.min(c.width,c.height)*.6
      );
      g.addColorStop(0,'rgba(120,170,220,0.06)');
      g.addColorStop(1,'rgba(120,170,220,0)');
      ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height);
    }
    requestAnimationFrame(loop);
  })();
})();
</script>
</body>
</html>
