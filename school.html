<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è˜­è–©çˆ¾å°å­¸ RPG | SnowWolf HUB v6.2 COMPLETE</title>

<!-- ğŸ”¹ å¥—ä»¶ -->
<script src="https://cdn.jsdelivr.net/npm/three@0.105.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/panolens@0.12.0/build/panolens.min.js"></script>
<link rel="stylesheet" href="css/style.css" />

<style>
#loading {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  color: #9ad6ff;
  font-size: 18px;
  z-index: 999;
}
.hidden { display: none; }
</style>
</head>

<body>
<div id="loading">â³ æ­£åœ¨è¼‰å…¥å­¸åœ’ä¸–ç•Œ...</div>

<!-- === Panorama èƒŒæ™¯ === -->
<div id="panoWrap"><div id="panoMount"></div></div>

<!-- === â„ï¸ é›ªèˆ‡ âœ¨ ç²’å­ç‰¹æ•ˆå±¤ === -->
<canvas id="snow"></canvas>
<div id="fx_particles"></div>

<!-- === ğŸ® ä»‹é¢å±¤ === -->
<div id="ui">

  <!-- ğŸ”¹ å°è¦½åˆ— -->
  <div class="topbar">
    <button class="chip" data-jump="isaac_home.html">ğŸ  è‰¾è–©å…‹çš„å®¶</button>
    <button class="chip" data-jump="wardrobe.html">ğŸ§¥ è¡£æ«ƒ</button>
    <button class="chip" data-jump="inventory.html">ğŸ’ é“å…·</button>
    <div class="spacer"></div>
    <button id="bgmBtn" class="chip">ğŸ”Š BGM é–‹</button>
  </div>

  <!-- ğŸ”¹ ç‹€æ…‹ HUD -->
  <div id="hud">
    <div class="attr" id="hudC"><span>å‹‡æ°£</span><b>24</b></div>
    <div class="attr" id="hudE"><span>åŒç†</span><b>18</b></div>
    <div class="attr" id="hudT"><span>çœŸå¯¦</span><b>12</b></div>
  </div>

  <!-- ğŸ”¹ ä»»å‹™æ¸…å–® -->
  <div id="questBox">
    <h4>ä»»å‹™ Quest</h4>
    <ul id="questList"></ul>
  </div>

  <!-- ğŸ”¹ å°è©±æ¡† -->
  <div id="dialogBox" class="dialog hidden">
    <div class="avatar"><img id="ava" src="" alt="NPC"></div>
    <div class="text">
      <div id="who" class="who"></div>
      <div id="line" class="line"></div>
    </div>
    <button id="next" class="btn">ä¸‹ä¸€å¥ â–¶</button>
  </div>

  <!-- ğŸ”¹ å ´æ™¯æŒ‰éˆ• -->
  <div id="sceneBtns">
    <button class="hotbtn" data-pan="gate">æ ¡é–€å£</button>
    <button class="hotbtn" data-pan="classroom">æ•™å®¤</button>
    <button class="hotbtn" data-pan="library">åœ–æ›¸é¤¨</button>
    <button class="hotbtn" data-pan="music">éŸ³æ¨‚æ•™å®¤</button>
    <button class="hotbtn" data-pan="art">ç¾è¡“æ•™å®¤</button>
    <button class="hotbtn" data-pan="playground">æ“å ´</button>
    <button class="hotbtn" data-pan="principal">æ ¡é•·å®¤</button>
  </div>

  <!-- ğŸ”¹ å¿«æ·åˆ— -->
  <div class="shortcut">
    <button class="chip" data-jump="dormitory.html">ğŸ« å®¿èˆ</button>
    <button class="chip" data-jump="courtyard.html">ğŸ“œ ä½ˆå‘Šæ¬„</button>
    <button class="chip" data-jump="hall.html">ğŸ›ï¸ æˆå°±æ®¿å ‚</button>
  </div>

</div>

<!-- === éŸ³æ¨‚èˆ‡éŸ³æ•ˆ === -->
<audio id="sfx" src="sfx/click.wav" preload="auto"></audio>
<audio id="bgm_day" src="audio/school_day.mp3" loop></audio>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* === ğŸµ éŸ³æ¨‚å•Ÿå‹• === */
  const bgm = document.getElementById("bgm_day");
  bgm.volume = 0.4;
  const playBGM = () => { bgm.play().catch(()=>{}); };
  document.body.addEventListener("click", playBGM, { once:true });

  /* === â„ï¸ é›ªç‰¹æ•ˆ === */
  const snowCanvas = document.getElementById("snow");
  const ctx = snowCanvas.getContext("2d");
  let snowflakes = [];
  function resize() { snowCanvas.width = innerWidth; snowCanvas.height = innerHeight; }
  window.addEventListener("resize", resize); resize();
  for(let i=0;i<180;i++){ snowflakes.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*3+1,d:Math.random()+0.5}); }
  function drawSnow(){
    ctx.clearRect(0,0,innerWidth,innerHeight);
    ctx.fillStyle="rgba(255,255,255,0.8)";
    ctx.beginPath();
    for(let s of snowflakes){ ctx.moveTo(s.x,s.y); ctx.arc(s.x,s.y,s.r,0,Math.PI*2,true); }
    ctx.fill();
    for(let s of snowflakes){ s.y+=s.d; if(s.y>innerHeight){s.y=0;s.x=Math.random()*innerWidth;} }
    requestAnimationFrame(drawSnow);
  } drawSnow();

  /* === âœ¨ é­”æ³•ç²’å­ === */
  const fx=document.getElementById("fx_particles");
  for(let i=0;i<80;i++){
    const p=document.createElement("div");
    p.className="particle";
    p.style.left=Math.random()*100+"vw";
    p.style.animationDuration=8+Math.random()*10+"s";
    p.style.animationDelay=Math.random()*8+"s";
    fx.appendChild(p);
  }

  /* === ğŸ“· Panorama === */
  let viewer,currentPano;
  const PANO={
    gate:"img/360/school_gate_360.jpg",
    classroom:"img/360/school_classroom_360.jpg",
    library:"img/360/school_library_360.jpg",
    music:"img/360/school_music_360.jpg",
    art:"img/360/school_art_360.jpg",
    playground:"img/360/school_playground_360.jpg",
    principal:"img/360/school_office_360.jpg"
  };
  function ensureViewer(){
    if(!viewer){
      viewer=new PANOLENS.Viewer({
        container:document.querySelector("#panoMount"),
        controlBar:false,autoHideInfospot:true,cameraFov:75
      });
    }
    return viewer;
  }
  function setScene(name){
    const url=PANO[name];
    if(!url)return;
    const v=ensureViewer();
    if(currentPano){v.remove(currentPano);}
    currentPano=new PANOLENS.ImagePanorama(url);
    v.add(currentPano);
    v.setPanorama(currentPano);
  }

  /* === ğŸ’¬ å°è©±èˆ‡ä»»å‹™ === */
  const dialog=$("#dialogBox"),who=$("#who"),line=$("#line"),ava=$("#ava"),next=$("#next");
  const questList=$("#questList");
  let questStatus={},cur=0,activeDialogue=[];

  function showLine(o){who.textContent=o.n;line.textContent=o.t;ava.src=o.a||"img/npc/system.png";}
  function addQuest(q){ if(!questStatus[q]){questStatus[q]={done:false};const li=document.createElement("li");li.textContent="ğŸ—’ "+q;li.dataset.q=q;questList.appendChild(li);} }
  function completeQuest(q){const li=questList.querySelector(`[data-q="${q}"]`);if(li){li.textContent="âœ… "+q;li.style.color="#ffd96a";questStatus[q].done=true;}}
  function updateStat(id,val){
  const el = $("#hud"+id);
  const num = el.querySelector("b");
  num.textContent = parseInt(num.textContent)+val;
  el.classList.add("gain");
  setTimeout(()=>el.classList.remove("gain"),1500);

  // ğŸ’« æ–°å¢æµ®å‹•ç‰¹æ•ˆ
  const floatLayer = document.getElementById("statFloatLayer");
  const text = document.createElement("div");
  let label = "";
  if(id==="C") label = "+å‹‡æ°£";
  if(id==="E") label = "+åŒç†";
  if(id==="T") label = "+çœŸå¯¦";
  text.className = "stat-float";
  text.textContent = label;
  floatLayer.appendChild(text);
  setTimeout(()=>text.remove(),1600);
}

  const SCENE_DIALOGUE={
    music:[{n:"éŸ³æ¨‚è€å¸«",a:"img/npc/teacher.png",t:"ä»Šå¤©æˆ‘å€‘ä¾†è†è½å¿ƒçš„ç¯€å¥ã€‚"},
           {n:"éŸ³æ¨‚è€å¸«",a:"img/npc/teacher.png",t:"éŸ³æ¨‚è®“æˆ‘å€‘æ›´æ‡‚å¾—å½¼æ­¤ã€‚"},
           {n:"éŸ³æ¨‚è€å¸«",a:"img/npc/teacher.png",t:"å½ˆå¥ä½ çš„å‹‡æ°£ä¹‹éŸ³å§ï¼"},
           {n:"éŸ³æ¨‚è€å¸«",a:"img/npc/teacher.png",t:"ç¯€å¥ç©©å®šã€æƒ…æ„Ÿé£½æ»¿ã€‚"},
           {n:"éŸ³æ¨‚è€å¸«",a:"img/npc/teacher.png",t:"å¤ªå¥½äº†ï¼ä½ ç²å¾—åŒç†+1ã€‚"}],
    art:[{n:"ç¾è¡“è€å¸«",a:"img/npc/teacher.png",t:"è—è¡“å°±æ˜¯å‹‡æ°£èˆ‡çœŸå¯¦çš„é¡è‰²ã€‚"},
         {n:"ç¾è¡“è€å¸«",a:"img/npc/teacher.png",t:"åˆ¥æ€•éŒ¯èª¤ï¼Œæ¯ä¸€ç­†éƒ½é‡è¦ã€‚"},
         {n:"ç¾è¡“è€å¸«",a:"img/npc/teacher.png",t:"é€™å¹…ç•«å……æ»¿ç”Ÿå‘½åŠ›ã€‚"},
         {n:"ç¾è¡“è€å¸«",a:"img/npc/teacher.png",t:"ç­†è§¸ä¸­çš„å…‰å¾ˆå‹•äººã€‚"},
         {n:"ç¾è¡“è€å¸«",a:"img/npc/teacher.png",t:"å‹‡æ°£+2ï¼ä»»å‹™å®Œæˆã€‚"}],
    library:[{n:"åœ–æ›¸ç®¡ç†å“¡",a:"img/npc/teacher.png",t:"é€™è£¡è—è‘—æ™‚é–“çš„ç§˜å¯†ã€‚"},
             {n:"åœ–æ›¸ç®¡ç†å“¡",a:"img/npc/teacher.png",t:"æ¯æœ¬æ›¸éƒ½åœ¨ä½èªã€‚"},
             {n:"åœ–æ›¸ç®¡ç†å“¡",a:"img/npc/teacher.png",t:"ä½ ç™¼ç¾ä¸€æœ¬æœƒç¿»é çš„æ›¸ã€‚"},
             {n:"ç³»çµ±",a:"img/npc/system.png",t:"çœŸå¯¦+2ï¼ç²å¾—ã€æ™‚é–“ç§˜å¢ƒä¹‹æ›¸ã€ã€‚"}],
    classroom:[{n:"è€å¸«",a:"img/npc/teacher.png",t:"ä»Šå¤©çš„ä¸»é¡Œæ˜¯å‹‡æ°£ã€‚"},
               {n:"è€å¸«",a:"img/npc/teacher.png",t:"èª°é¡˜æ„åˆ†äº«è‡ªå·±çš„ç¶“é©—ï¼Ÿ"},
               {n:"å­¸ç”Ÿ",a:"img/npc/teacher.png",t:"æˆ‘æ›¾å®³æ€•ç™¼è¡¨ï¼Œä½†æˆ‘é‚„æ˜¯å˜—è©¦äº†ã€‚"},
               {n:"è€å¸«",a:"img/npc/teacher.png",t:"å¤ªå¥½äº†ï¼å‹‡æ°£+1ï¼"}],
    playground:[{n:"ç³»çµ±",a:"img/npc/system.png",t:"ä½ åœ¨é›ªä¸­ç™¼ç¾ä¸€æšå¾½ç« ã€‚"},
                {n:"ç³»çµ±",a:"img/npc/system.png",t:"å¾½ç« é–ƒè€€è‘—å…‰èŠ’ã€‚"},
                {n:"ç³»çµ±",a:"img/npc/system.png",t:"å‹‡æ°£+1ã€‚"}],
    principal:[{n:"æ ¡é•·â€§ç¾…å€«æ–¯",a:"img/npc/principal.png",t:"çœŸå¯¦æ¯”å‹åˆ©æ›´é‡è¦ã€‚"},
               {n:"æ ¡é•·â€§ç¾…å€«æ–¯",a:"img/npc/principal.png",t:"å¸¶è‘—å…‰å‰è¡Œå§ã€‚"},
               {n:"ç³»çµ±",a:"img/npc/system.png",t:"çœŸå¯¦+2ï¼ä»»å‹™å®Œæˆã€‚"}]
  };

  function startDialogue(lines,onFinish){
    dialog.classList.remove("hidden");
    activeDialogue=lines; cur=0;
    showLine(activeDialogue[cur]);
    next.onclick=()=>{
      cur++;
      if(cur<activeDialogue.length){showLine(activeDialogue[cur]);}
      else{dialog.classList.add("hidden");if(onFinish)onFinish();}
    };
  }

  function triggerSceneLogic(scene){
    const lines=SCENE_DIALOGUE[scene];
    if(!lines) return;
    startDialogue(lines,()=>{
      switch(scene){
        case "music": addQuest("éŸ³æ¨‚ä»»å‹™"); completeQuest("éŸ³æ¨‚ä»»å‹™"); updateStat("E",1); break;
        case "art": addQuest("ç¾è¡“ä»»å‹™"); completeQuest("ç¾è¡“ä»»å‹™"); updateStat("C",2); break;
        case "library": addQuest("åœ–æ›¸é¤¨ä»»å‹™"); completeQuest("åœ–æ›¸é¤¨ä»»å‹™"); updateStat("T",2); break;
        case "classroom": addQuest("æ•™å®¤ä»»å‹™"); completeQuest("æ•™å®¤ä»»å‹™"); updateStat("C",1); break;
        case "playground": addQuest("æ“å ´ä»»å‹™"); completeQuest("æ“å ´ä»»å‹™"); updateStat("C",1); break;
        case "principal": addQuest("æ ¡é•·å®¤ä»»å‹™"); completeQuest("æ ¡é•·å®¤ä»»å‹™"); updateStat("T",2); break;
      }
    });
  }

  /* === æŒ‰éˆ•ç¶å®š === */
  document.querySelectorAll("[data-pan]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.getElementById("sfx").play().catch(()=>{});
      setScene(btn.dataset.pan);
      triggerSceneLogic(btn.dataset.pan);
    });
  });
  document.querySelectorAll("[data-jump]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.getElementById("sfx").play().catch(()=>{});
      location.href=btn.dataset.jump;
    });
  });

  /* === é–‹å ´å°è©± === */
  const opening=[
    {n:"æ ¡é•·â€§ç¾…å€«æ–¯",a:"img/npc/principal.png",t:"æ­¡è¿å›åˆ°è˜­è–©çˆ¾å°å­¸ã€‚"},
    {n:"æ ¡é•·â€§ç¾…å€«æ–¯",a:"img/npc/principal.png",t:"å‹‡æ°£ã€åŒç†èˆ‡çœŸå¯¦ï¼Œæ˜¯æˆé•·çš„ä¸‰æŠŠé‘°åŒ™ã€‚"},
    {n:"æ ¡é•·â€§ç¾…å€«æ–¯",a:"img/npc/principal.png",t:"å»å§ï¼Œé–‹å•Ÿå±¬æ–¼ä½ çš„å†’éšªï¼"}
  ];
  function startOpening(){ startDialogue(opening,()=>addQuest("åºç« ï¼šè¸å…¥è˜­è–©çˆ¾")); }

  /* === å•Ÿå‹• === */
  setScene("gate");
  setTimeout(()=>{startOpening();$("#loading").style.display="none";},800);

});

/* å°å·¥å…· */
function $(q,sc=document){return sc.querySelector(q);}
function $$(q,sc=document){return Array.from(sc.querySelectorAll(q));}
</script>

<!-- ğŸ’« å±¬æ€§åŠ æˆæ–‡å­—ç‰¹æ•ˆå±¤ -->
<div id="statFloatLayer"></div>

</body>
</html>
