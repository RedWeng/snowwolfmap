<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é›ªç‹¼ç”·å­©ï¼šç©†é«˜çˆ¾æ£®æ—ä¹‹é–€</title>

<!-- æ¨£å¼ -->
<link rel="stylesheet" href="css/forest_gate_style.css" />

<style>
/* ğŸ¥ èƒŒæ™¯å‹•ç•«å½±ç‰‡ */
#bgVideo {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: brightness(1.08) contrast(1.1) saturate(1.05);
  animation: fadeInBg 2s ease forwards;
  z-index: 0;
}
@keyframes fadeInBg {
  from {opacity:0; transform:scale(1.03);}
  to {opacity:1; transform:scale(1);}
}
#fogLayer {position:fixed;inset:0;z-index:3;pointer-events:none;}
#leafLayer {position:fixed;inset:0;z-index:4;pointer-events:none;}
</style>
</head>

<body>
<!-- ğŸ¥ èƒŒæ™¯å‹•ç•« -->
<video id="bgVideo" autoplay muted playsinline>
  <source src="video/forest_gate_loop.mp4" type="video/mp4" />
  <source src="video/forest_gate_loop.webm" type="video/webm" />
</video>

<!-- âœ¨ ç‰¹æ•ˆå±¤ -->
<canvas id="fogLayer"></canvas>
<div id="leafLayer"></div>
<div class="fx-glow"></div>

<!-- ğŸ”¹ å°è¦½åˆ— -->
<div class="topbar">
  <button class="chip" data-jump="isaac_home_basement_v3.9.html">â¬…ï¸ å›åœ°ä¸‹å®¤</button>
  <div class="spacer"></div>
  <button class="chip" data-jump="wardrobe.html">ğŸ§¥ è¡£æ«ƒ</button>
  <button class="chip" data-jump="inventory.html">ğŸ’ é“å…·</button>
  <button id="bgmBtn" class="chip">ğŸ”Š BGM é–‹</button>
</div>

<!-- ğŸ”¹ HUD ç‹€æ…‹åˆ— -->
<div id="hud">
  <div class="attr" id="hudC"><span>å‹‡æ°£</span><b>0</b></div>
  <div class="attr" id="hudE"><span>åŒç†</span><b>0</b></div>
  <div class="attr" id="hudT"><span>çœŸå¯¦</span><b>0</b></div>
</div>

<!-- ğŸ’¬ å°è©±æ¡† -->
<div id="dialoguePortrait"><img id="portraitImg" src="avatars/isaac.png" /></div>
<div id="dialogueBox">
  <div id="dialogueCharacter"></div>
  <div id="dialogueText"></div>
  <button id="nextBtn">ä¸‹ä¸€å¥ â–¶</button>
</div>

<!-- ğŸ“œ ä»»å‹™ -->
<div id="questBox"><h4>ä»»å‹™ Quest</h4><ul id="questList"></ul></div>
<button id="toggleQuest">ğŸ“œ ä»»å‹™</button>

<!-- ğŸšª é–‹é–€æŒ‰éˆ• -->
<button id="openGateBtn">ğŸŒ€ å•Ÿå‹•æ£®æ—å°å°ä¹‹é–€</button>

<!-- âœ… ç›´æ¥å…§åµŒä¸»é‚è¼¯ï¼Œç¢ºä¿æ‰€æœ‰å…ƒç´ è¼‰å…¥å¾ŒåŸ·è¡Œ -->
<script>
window.addEventListener("load",()=>{

  // === éŸ³æ¨‚ ===
  const bgm=new Audio("audio/bgm_forest_gate.mp3");
  bgm.loop=true; bgm.volume=0.5;
  const fxOpen=new Audio("audio/fx_gate_open.mp3");
  const fxMist=new Audio("audio/fx_mist_loop.mp3");
  fxMist.loop=true; fxMist.volume=0.35;

  // === æŒ‰éˆ•å°èˆª ===
  document.querySelectorAll("[data-jump]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const link=btn.getAttribute("data-jump");
      document.body.classList.add("fade-out");
      setTimeout(()=>window.location.href=link,300);
    });
  });

  // === éŸ³æ¨‚é–‹é—œ ===
  const bgmBtn=document.getElementById("bgmBtn");
  bgmBtn.onclick=()=>{
    if(bgm.paused){bgm.play();bgmBtn.textContent="ğŸ”Š BGM é–‹";}
    else{bgm.pause();bgmBtn.textContent="ğŸ”‡ BGM é—œ";}
  };
  // è‡ªå‹•æ’­æ”¾å˜—è©¦
  const start=()=>{bgm.play().catch(()=>{});document.removeEventListener("click",start);};
  document.addEventListener("click",start);

  // === éœ§æ°£ ===
  const canvas=document.getElementById("fogLayer");
  const ctx=canvas.getContext("2d");
  canvas.width=innerWidth; canvas.height=innerHeight;
  const fogs=Array.from({length:30},()=>({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    r:80+Math.random()*120,
    o:0.04+Math.random()*0.07,
    s:0.3+Math.random()*0.5
  }));
  (function drawFog(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const f of fogs){
      ctx.beginPath();
      ctx.fillStyle=`rgba(200,230,255,${f.o})`;
      ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
      ctx.fill();
      f.x+=Math.sin(Date.now()*0.0002)*f.s;
      f.y+=Math.cos(Date.now()*0.0003)*f.s;
      if(f.x>canvas.width)f.x=-f.r;
      if(f.y>canvas.height)f.y=-f.r;
    }
    requestAnimationFrame(drawFog);
  })();

  // === å°è©±ç³»çµ± ===
  const dialogueBox=document.getElementById("dialogueBox");
  const charEl=document.getElementById("dialogueCharacter");
  const textEl=document.getElementById("dialogueText");
  const nextBtn=document.getElementById("nextBtn");
  let lines=[],index=0,callback=null;

  function playDialogue(l,cb){lines=l;index=0;callback=cb;dialogueBox.style.display="block";showLine();}
  function showLine(){
    if(index>=lines.length){dialogueBox.style.display="none";callback&&callback();return;}
    const line=lines[index++];
    charEl.textContent=line.n;
    textEl.textContent="";
    let i=0;
    const typer=setInterval(()=>{
      textEl.textContent=line.t.slice(0,i++);
      if(i>line.t.length)clearInterval(typer);
    },40);
  }
  nextBtn.onclick=showLine;

  // === ä»»å‹™ç³»çµ± ===
  const questBox=document.getElementById("questBox");
  document.getElementById("toggleQuest").onclick=()=>questBox.classList.toggle("active");
  const questList=document.getElementById("questList");
  function addQuest(q){const li=document.createElement("li");li.textContent="ğŸ—’ "+q;questList.appendChild(li);}

  // === é–‹å ´åŠ‡æƒ… ===
  setTimeout(()=>{
    playDialogue([
      {n:"è‰¾è–©å…‹",t:"â€¦â€¦é€™è£¡å°±æ˜¯çˆ¶è¦ªæåˆ°çš„ã€ç©†é«˜çˆ¾æ£®æ—ã€ï¼Ÿ"},
      {n:"è‰¾è–©å…‹",t:"é‚£é“å·¨é–€â€¦â€¦å½·å½¿åœ¨ç­‰å¾…èª°ä¾†é–‹å•Ÿå®ƒã€‚"},
      {n:"ç³»çµ±",t:"ä»»å‹™æ›´æ–°ï¼šå•Ÿå‹•æ£®æ—å°å°ä¹‹é–€ã€‚"}
    ],()=>addQuest("å•Ÿå‹•æ£®æ—å°å°ä¹‹é–€"));
  },1000);

  // === é–‹é–€å‹•ä½œ ===
  const openBtn=document.getElementById("openGateBtn");
  const glow=document.querySelector(".fx-glow");
  openBtn.onclick=()=>{
    fxOpen.play(); fxMist.play();
    glow.classList.add("active");
    openBtn.disabled=true;
    openBtn.textContent="å•Ÿå‹•ä¸­â€¦";
    setTimeout(()=>{
      openBtn.style.display="none";
      playDialogue([
        {n:"è‰¾è–©å…‹",t:"å…‰â€¦â€¦æ­£åœ¨å›æ‡‰æˆ‘ï¼Ÿ"},
        {n:"è‰¾è–©å…‹",t:"é€™è‚¡åŠ›é‡ï¼Œåƒæ˜¯æ£®æ—æœ¬èº«çš„å‘¼å¸ã€‚"},
        {n:"ç³»çµ±",t:"ä»»å‹™å®Œæˆï¼šè§£é–è¨˜æ†¶æ ¸å¿ƒï¼Œæ­é–‹é›ªç‹¼ä¹‹è¬ã€‚"}
      ],()=>{
        addQuest("è§£é–è¨˜æ†¶æ ¸å¿ƒï¼Œæ­é–‹é›ªç‹¼ä¹‹è¬");
        setTimeout(()=>{
          const nextBtn=document.createElement("button");
          nextBtn.textContent="â¡ï¸ å‰å¾€ç©†é«˜çˆ¾æ£®æ—";
          nextBtn.className="chip";
          nextBtn.style.position="absolute";
          nextBtn.style.bottom="30px";
          nextBtn.style.right="30px";
          nextBtn.style.zIndex=50;
          document.body.appendChild(nextBtn);
          nextBtn.onclick=()=>{document.body.classList.add("fade-out");setTimeout(()=>window.location.href="mugor_forest.html",500);};
        },2000);
      });
    },3000);
  };
});
</script>
</body>
</html>
