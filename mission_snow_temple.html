<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é›ªä¹‹è–æ®¿ | Mission â€“ Snow Temple</title>
<link rel="preload" as="audio" href="sfx/electric.wav">
<style>
  :root{
    --bg:#0e1520; --panel:#111a27; --panel2:#0b1220; --ink:#e7eefb;
    --muted:#7f91a8; --primary:#78a2ff; --accent:#9ad6ff; --ok:#39d98a;
    --chip:#1a2536; --shadow:0 10px 40px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:#000;margin:0}
  body{
    font-family:ui-rounded, system-ui, "PingFang TC", "Noto Sans TC", sans-serif;
    color:var(--ink);
    background:radial-gradient(1200px 900px at 50% 30%, #172234 0%, #0a0f19 65%, #05070d 100%) fixed;
  }

  /* èƒŒæ™¯å½±ç‰‡ï¼šä¿®æ­£ stackingï¼Œä¿è­‰å¯è¦‹ */
  .bg{
    position:fixed; inset:0; overflow:hidden; z-index:0; pointer-events:none;
  }
  .bg video{
    position:absolute; inset:0;
    width:100%; height:100%; object-fit:cover; display:block;
    filter:contrast(1.05) brightness(.92) saturate(1.02);
  }

  /* Top å¿«æ· */
  .topbar{position:fixed;left:18px;right:18px;top:12px;display:flex;gap:12px;align-items:center;z-index:10}
  .chip{background:var(--chip);color:#cfe1ff;border:1px solid #22314a;border-radius:999px;padding:8px 12px;font-size:13px;display:inline-flex;gap:8px;align-items:center;box-shadow:var(--shadow)}
  .chip svg{width:16px;height:16px;opacity:.9}
  .spacer{flex:1}

  /* æƒ…ç·’æ¢ */
  .bars{position:fixed;left:18px;top:56px;right:18px;display:flex;gap:36px;z-index:9}
  .bar{width:360px;max-width:30vw}
  .bar label{display:block;font-size:12px;color:#b9c8e6;margin:0 0 4px 2px}
  .meter{height:6px;background:#0d1830;border:1px solid #1e2c47;border-radius:999px;overflow:hidden}
  .meter span{display:block;height:100%;background:linear-gradient(90deg,#4aa3ff,#9ad6ff);width:10%;transition:width .35s}

  /* è¡Œå‹• Dockï¼ˆä¸‰é¸ä¸€ï¼‰â€” é è¨­ä¸é¡¯ç¤ºï¼›æœ€å¾Œæ‰ç½®ä¸­å‡ºç¾ */
  #actionsDock{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    display:none; gap:12px; z-index:11;
    background:rgba(6,12,22,.55); backdrop-filter:blur(8px);
    padding:16px; border:1px solid #22314a; border-radius:16px;
  }
  #actionsDock .btn{background:#142036;border:1px solid #22314a;color:#d7e6ff;padding:10px 14px;border-radius:14px;font-size:14px;box-shadow:var(--shadow)}
  #actionsDock .btn:hover{filter:brightness(1.1)}
  @media (max-width: 720px){
    #actionsDock{flex-direction:column; align-items:center; width:min(92vw,520px)}
  }

  /* é“å…· BARï¼ˆå°ã€ä¸æ“‹å°è©±ï¼‰ */
  .invBar{position:fixed;left:18px;bottom:160px;width:min(860px,60vw);background:linear-gradient(180deg,#0f1724,#0b121f);border:1px solid #1f2a42;border-radius:20px;padding:12px 14px;box-shadow:var(--shadow);z-index:7}
  .invBar h5{margin:0 0 6px 2px;font-weight:600;font-size:14px;color:#cfe1ff;display:flex;align-items:center;gap:12px}
  .owned{font-size:12px;color:#8ea4c6}
  .invRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .invItem{width:78px;height:56px;border-radius:12px;overflow:hidden;border:1px solid #23344d;background:#0a1221;cursor:pointer;position:relative}
  .invItem img{width:100%;height:100%;object-fit:cover}
  .invItem b{position:absolute;right:6px;bottom:4px;background:#0c1c33b0;border:1px solid #2b3f64;border-radius:999px;padding:1px 6px;font-size:11px;color:#d7ecff}
  .invBtns{margin-left:auto;display:flex;gap:8px}
  .tiny{font-size:12px;padding:6px 10px;border-radius:999px;background:#142036;border:1px solid #22314a;color:#cfe1ff}

  /* å°è©±æ¡† */
  .dialog{position:fixed;left:18px;right:18px;bottom:18px;background:linear-gradient(180deg,#0d1524e6,#0a111ee6);backdrop-filter:blur(8px);border:1px solid #1a2a44;border-radius:22px;padding:18px 22px 18px 22px;display:grid;grid-template-columns:88px 1fr auto;gap:18px;align-items:end;z-index:6}
  .avatar{width:88px;height:88px;border-radius:16px;overflow:hidden;border:1px solid #273a5a;background:#0a1322}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .lines{min-height:64px}
  .who{font-weight:700;font-size:18px;margin:0 0 6px}
  .line{font-size:18px;color:#e9f2ff;letter-spacing:.5px}
  .diaBtns{display:flex;gap:10px;align-items:center}
  .btn{background:#173055;color:#e7f1ff;border:1px solid #27426e;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;box-shadow:var(--shadow)}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* æ¨¡æ…‹ï¼šè¡£æ«ƒã€é“å…·åº« */
  .modal{position:fixed;inset:0;background:rgba(3,8,16,.55);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:20}
  .modal.show{display:flex}
  .panel{width:min(1120px,92vw);max-height:80vh;overflow:auto;background:linear-gradient(180deg,#0f1829,#0b1221);border:1px solid #1e2b45;border-radius:22px;box-shadow:var(--shadow);padding:18px}
  .panel h3{margin:6px 6px 12px;font-size:18px;color:#d9e8ff}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:linear-gradient(180deg,#0d1626,#0a121f);border:1px solid #22314a;border-radius:18px;padding:12px}
  .media{width:100%;aspect-ratio:3/4;border-radius:12px;overflow:hidden;background:#0a1322;border:1px solid #20314b;margin-bottom:10px}
  .media img,.media video{width:100%;height:100%;object-fit:cover;display:block}
  .card h4{margin:2px 0 8px;font-size:15px}
  .muted{color:#9db1cf;font-size:13px;margin:0 0 10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .close{position:sticky;top:0;float:right;margin-left:auto}

  /* é“å…·åº«ï¼ˆå¤§é¢æ¿ï¼‰ */
  .storeGrid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .storeCard{display:grid;grid-template-columns: 1fr 1fr;gap:14px;background:linear-gradient(180deg,#0f1829,#0b1221);border:1px solid #21324d;border-radius:18px;padding:12px}
  .storeHero{grid-column:1/3;width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;border:1px solid #20314b;background:#0a1322}
  .storeHero img{width:100%;height:100%;object-fit:cover}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .chipSmall{font-size:12px;padding:4px 8px;border-radius:999px;background:#13223c;border:1px solid #233a61;color:#cfe1ff}
  .rowR{display:flex;gap:8px;margin-top:auto}

  /* æç¤º */
  .toast{position:fixed;right:18px;bottom:18px;background:#0c1a30;color:#dff2ff;border:1px solid #234168;border-radius:12px;padding:10px 14px;box-shadow:var(--shadow);z-index:50;display:none}
</style>
</head>
<body>

<!-- èƒŒæ™¯å½±ç‰‡ -->
<div class="bg">
  <video id="bgvid" autoplay muted playsinline webkit-playsinline loop preload="auto" poster="img/bg/snow_temple.jpg">
    <source src="media/snow_temple_loop.webm" type="video/webm">
    <source src="media/snow_temple_loop.mp4" type="video/mp4">
  </video>
</div>

<!-- Top å¿«æ· -->
<div class="topbar">
  <button class="chip" data-jump="home.html">ğŸ  è‰¾è–©å…‹çš„å®¶</button>
  <button class="chip" data-jump="school.html">ğŸ« è˜­è–©çˆ¾å°å­¸</button>
  <button class="chip" data-jump="map_world.html">ğŸ—ºï¸ ä¸–ç•Œåœ°åœ–</button>
  <div class="spacer"></div>
  <button id="lang" class="chip">ä¸­æ–‡/EN</button>
  <button id="bgm" class="chip">BGMï¼šé–‹</button>
  <button id="wardrobeBtn" class="chip">ğŸ§¥ æ›è£ / Wardrobe</button>
  <button id="storeBtn" class="chip">ğŸ§° é“å…·å•†åº—</button>
</div>

<!-- æƒ…ç·’æ¢ -->
<div class="bars">
  <div class="bar"><label id="lblC">å‹‡æ°£ Courage</label><div class="meter"><span id="mC" style="width:12%"></span></div></div>
  <div class="bar"><label id="lblE">åŒç† Empathy</label><div class="meter"><span id="mE" style="width:8%"></span></div></div>
  <div class="bar"><label id="lblT">çœŸå¯¦ Truth</label><div class="meter"><span id="mT" style="width:5%"></span></div></div>
</div>

<!-- è¡Œå‹• Dockï¼ˆä¸å£“åˆ°å°è©±ï¼›æœ€å¾Œç½®ä¸­å‡ºç¾ï¼‰ -->
<div id="actionsDock">
  <button class="btn act" data-goto="treasure">é€²å…¥è–æ®¿å¯¶è— / Treasure</button>
  <button class="btn act" data-goto="leave">é›¢é–‹è–æ®¿ / Leave</button>
  <button class="btn act" data-goto="search">å°‹æ‰¾å¤±è¹¤å­©å­ / Search</button>
</div>

<!-- é“å…· BARï¼ˆå°ï¼‰ -->
<div class="invBar">
  <h5>é“å…· / Inventory <span class="owned">ï¼ˆå·²æ“æœ‰ <span id="invCount">0</span> ä»¶ï¼‰</span></h5>
  <div class="invRow" id="invRow"></div>
  <div class="invBtns">
    <button id="openStore" class="tiny">é“å…·åº« / å•†åº—</button>
  </div>
</div>

<!-- å°è©± -->
<div class="dialog" id="dialog">
  <div class="avatar"><img id="ava" src="img/avatars/heather.png" alt=""></div>
  <div class="lines">
    <div class="who" id="who">æµ·ç‘Ÿ</div>
    <div class="line" id="line">ã€Œé€™è£¡â€¦â€¦å°±æ˜¯é›ªä¹‹è–æ®¿ï¼Ÿç©ºæ°£åƒæœƒç™¼å…‰ä¸€æ¨£ã€‚ã€</div>
  </div>
  <div class="diaBtns">
    <button id="next" class="btn">ä¸‹ä¸€å¥ â–¶</button>
    <button id="auto" class="btn">è‡ªå‹•æ’­æ”¾</button>
  </div>
</div>

<!-- è¡£æ«ƒ Modal -->
<div id="wardrobe" class="modal">
  <div class="panel">
    <button class="btn close" data-close="#wardrobe">é—œé–‰</button>
    <h3>æ›è£ / Wardrobe</h3>
    <div class="grid" id="wardrobeGrid"></div>
    <p class="muted">ï¼ˆç¾ç‚ºå ä½ç³»çµ±ï¼›ä¹‹å¾Œå¯æ¥è§’è‰² 2D/3D å¤–è§€èˆ‡å±¬æ€§åŠ æˆï¼‰</p>
  </div>
</div>

<!-- é“å…·åº« Modal -->
<div id="store" class="modal" data-store-url="store.html">
  <div class="panel">
    <div style="display:flex;gap:10px;align-items:center">
      <h3 style="margin-right:auto">é“å…·æ¬„ / Store & Library</h3>
      <a id="goStoreFull" class="btn" target="_blank">å‰å¾€é“å…·å•†åº—ï¼ˆå®Œæ•´é ï¼‰</a>
      <button class="btn close" data-close="#store">é—œé–‰</button>
    </div>
    <div class="storeGrid" id="storeGrid"></div>
  </div>
</div>

<audio id="sfx" src="sfx/electric.wav" preload="auto"></audio>
<audio id="bgma" src="audio/snow_temple_theme.mp3" loop></audio>
<div id="toast" class="toast"></div>

<script>
/* ---------- éŸ³æ•ˆ/BGM ---------- */
const SFX = document.getElementById('sfx');
const BGM = document.getElementById('bgma');
const toast = (t)=>{const n=document.getElementById('toast');n.textContent=t;n.style.display='block';setTimeout(()=>n.style.display='none',1400);}
const playSfx = ()=>{ try{ SFX.currentTime=0; SFX.play(); }catch{} }

/* ---------- ä½ çš„åŸæœ¬ stateï¼ˆåŠ‡æƒ…/æ¸…å–®ï¼‰ä¿ç•™ ---------- */
const state = {
  lang:'zh',
  auto:false,
  stats:{ C:12, E:8, T:5 },
  inv:[
    { id:'magic_fruit',   name:'é­”æ³•æœå­ / Magic Fruit', img:'img/items/magic_fruit.jpg', have:0, eff:{E:+2}, desc:'æƒ…ç·’è£œçµ¦ã€‚æ¯ä¸€é¡†è±¡å¾µå¸Œæœ›ã€å‹‡æ°£ã€ç©©å®šï¼Œæ²»ç™’ï¼Œèƒ½åœ¨è¢«æ™‚é–“å¤¾å‚·å£å…‰ã€‚' },
    { id:'comfort_food',  name:'ç‘ªç³çµ²å¤ªå¤ªçš„æ–™ç† / Comfort Food', img:'img/items/comfort_food.jpg', have:0, eff:{C:+1,E:+1}, desc:'å®¶çš„æº«åº¦ï¼Œæš–èƒƒæš–å¿ƒï¼Œè®“éšŠä¼æ¢å¾©é«”åŠ›èˆ‡ä¿¡å¿ƒã€‚' },
    { id:'time_book',     name:'æ™‚é–“ç¥•å¢ƒ / Time Book', img:'img/items/time_book.jpg', have:0, eff:{T:+2}, desc:'å­¸æœƒæ‰“é–‹ä¸åŒæ™‚ç©ºçš„é–€ã€‚é–±è®€å³æ˜¯ç©¿è¶Šã€‚' },
    { id:'wolf_whistle',  name:'é›ªç‹¼å“¨ / Wolf Whistle', img:'img/items/wolf_whistle.jpg', have:0, eff:{E:+1}, desc:'å¬å–šå¤¥ä¼´æ”¯æ´ï¼›å±æ€¥æ™‚åˆ»èƒ½å¼•ä¾†å¤¥ä¼´çš„å›æ‡‰ã€‚' },
    { id:'time_hourglass',name:'æ™‚é–“æ²™æ¼ / Time Hourglass', img:'img/items/time_hourglass.jpg', have:0, eff:{C:+1}, desc:'é‡‹æ”¾å¿ƒä¸­ç©ºæª”ï¼Œè®“æ€ç·’ä¸å†ä¸»å°æ±ºå®šã€‚' }
  ],
  wardrobe:[
    { id:'explorer_coat', title:'æ¢éšªè€…å¤–å¥— Explorer Coat', eff:{C:+1} },
    { id:'snow_cloak',    title:'é›ªåœ°æŠ«é¢¨ Snow Cloak',     eff:{E:+1} },
    { id:'seer_robe',     title:'è§€æ˜Ÿè€…é•·è¢ Seer Robe',    eff:{T:+1} },
  ],
  script: [
    { n:'æµ·ç‘Ÿ', a:'img/avatars/heather.png', t:'ã€Œé€™è£¡â€¦â€¦å°±æ˜¯é›ªä¹‹è–æ®¿ï¼Ÿç©ºæ°£åƒæœƒç™¼å…‰ä¸€æ¨£ã€‚ã€' },
    { n:'è¿ªæ©', a:'img/avatars/dean.png',    t:'ã€Œå°å¿ƒè…³ä¸‹ï¼Œé€™ç¨®åœ°å½¢å¾ˆå®¹æ˜“æ»‘å€’ã€‚é‡Œç‰¹ï¼Œåˆ¥é›¢å¤ªé ï¼ã€' },
    { n:'è‰¾è–©å…‹', a:'img/avatars/isaac.png',  t:'ã€Œç­‰ç­‰â€¦â€¦ä½ å€‘æœ‰è½åˆ°å—ï¼Ÿåƒæ˜¯â€¦é˜è²åœ¨é›ªè£¡è¿´ç›ªã€‚ã€' },
    { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œä½ å€‘çµ‚æ–¼ä¾†äº†ã€‚å­©å­å€‘ï¼Œæ­¡è¿å›åˆ°ã€é›…ç´¢å®¶æ—çš„æ®¿å ‚ã€ã€‚ã€' },
    { n:'æµ·ç‘Ÿ', a:'img/avatars/heather.png', t:'ã€Œå¦³æ˜¯â€¦â€¦è²äºçš„æ¯è¦ªï¼Ÿã€' },
    { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œæˆ‘æ˜¯å¥¹è¨˜æ†¶çš„å½±å­ï¼Œä¹Ÿæ˜¯é€™ç‰‡é›ªçš„å®ˆé–€äººã€‚ã€' },
    { n:'è‰¾è–©å…‹', a:'img/avatars/isaac.png', t:'ã€Œè¨˜æ†¶çš„â€¦â€¦å½±å­ï¼Ÿã€' },
    { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œåœ¨çœŸå¯¦èˆ‡å¤¢çš„é‚Šç•Œï¼Œå½±å­æ¯”è¨˜æ†¶æ›´èª å¯¦ã€‚ã€' },
    { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œæˆ‘åœ¨æ­¤å®ˆæœ›å¾ˆä¹…ï¼Œç‚ºç­‰ä½ å€‘å¸¶å›å¤±è½çš„å‹‡æ°£èˆ‡çœŸå¯¦ã€‚ã€' },
    { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œåœ¨ä½ å€‘é¢å‰æœ‰ä¸‰æ¢è·¯â€”é¸æ“‡ï¼Œå³æ˜¯ä»£åƒ¹ã€‚ã€', stop:true }
  ],
  branches:{
    treasure:[
      { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œå¯¶è—ä¸æ˜¯é‡‘éŠ€ï¼Œè€Œæ˜¯æœƒæ˜ ç…§å¿ƒæ„çš„ã€è¨˜æ†¶ä¹‹æ ¸ã€ã€‚ã€' },
      { n:'è‰¾è–©å…‹', a:'img/avatars/isaac.png', t:'ã€Œå¦‚æœèƒ½è¦‹åˆ°ä»–æœ€å¾Œä¸€æ¬¡â€¦â€¦æˆ‘æƒ³çŸ¥é“ä»–æ˜¯å¦é‚„æ´»è‘—ã€‚ã€' },
      { n:'ç³»çµ±', a:'', t:'å–å¾—é“å…·ï¼šè¨˜æ†¶ä¹‹æ ¸', act:()=>{ addInv('time_book'); } },
      { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œæº–å‚™å¥½äº†å°±è·Ÿæˆ‘ä¾†å§ã€‚ã€ï¼ˆå°‡å‰å¾€ï¼šè¨˜æ†¶ä¹‹æ ¸Â·å›æ”¶ä»»å‹™ï¼‰', link:'mission_core.html' }
    ],
    leave:[
      { n:'è¿ªæ©', a:'img/avatars/dean.png', t:'ã€Œç¾åœ¨æ’¤é›¢ä¸¦ä¸æ˜¯å¤±æ•—ï¼Œæ˜¯ç‚ºäº†æ›´å¥½çš„å›ä¾†ã€‚ã€' },
      { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œé“è·¯è‡ªæœƒç­‰å¾…ä½ å€‘ã€‚å¸¶è‘—æ¸…é†’é›¢é–‹ï¼Œä¹Ÿæ˜¯å‹‡æ°£ã€‚ã€', link:'map_world.html' }
    ],
    search:[
      { n:'æµ·ç‘Ÿ', a:'img/avatars/heather.png', t:'ã€Œæˆ‘è½è¦‹å°å°çš„è…³å°è²â€¦â€¦åœ¨æŸ±å»Šå¾Œé¢ï¼ã€' },
      { n:'é›…ç´¢å¦®å¨œ', a:'img/avatars/yasonina.png', t:'ã€Œè·Ÿè‘—éŠ€å…‰èµ°ï¼Œåˆ¥å›é ­ã€‚ã€' },
      { n:'ç³»çµ±', a:'', t:'ç›®æ¨™æ›´æ–°ï¼šæœå°‹å¤±è¹¤å­©å­ï¼ˆå€åŸŸï¼šåŒ—å´å´å»Šï¼‰', link:'mission_search.html' }
    ]
  }
};

/* ---------- å½±ç‰‡ä¿éšªæ©Ÿåˆ¶ï¼ˆiOS/ç€è¦½å™¨é˜»æ“‹æ™‚å•Ÿå‹•ï¼‰ ---------- */
const bgvid = document.getElementById('bgvid');
async function ensureBGVideo(){
  // è‹¥ä¾†æºéƒ½æ›äº†å‰‡é¡¯ç¤º posterï¼ˆè·¯å¾‘éŒ¯èª¤åµæ¸¬ï¼‰
  const sources = [...bgvid.querySelectorAll('source')].map(s=>s.src);
  let ok=false;
  for(const url of sources){
    try{
      const r = await fetch(url, { method:'HEAD' });
      if(r.ok){ ok=true; break; }
    }catch{}
  }
  if(!ok){
    console.warn('Background video sources not reachable, fallback to poster');
    return; // poster æœƒè‡ªå‹•é¡¯ç¤º
  }
  try{
    await bgvid.play();
  }catch(e){
    // ç­‰ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡äº’å‹•å¾Œå†æ’­æ”¾
    const kick = async ()=>{
      try{ await bgvid.play(); }catch{}
      window.removeEventListener('pointerdown', kick, {once:true});
      window.removeEventListener('keydown', kick, {once:true});
    };
    window.addEventListener('pointerdown', kick, {once:true});
    window.addEventListener('keydown', kick, {once:true});
  }
}

/* ---------- åŸºç¤ UI ç¶å®šï¼ˆä½ çš„åŸå§‹æµç¨‹ä¿ç•™ï¼‰ ---------- */
const lblC=document.getElementById('mC'), lblE=document.getElementById('mE'), lblT=document.getElementById('mT');
const invRow=document.getElementById('invRow'); const invCount=document.getElementById('invCount');
const wardrobeGrid=document.getElementById('wardrobeGrid'); const storeGrid=document.getElementById('storeGrid');

function clamp(n){return Math.max(0,Math.min(100,n))}
function syncBars(){
  lblC.style.width = clamp(state.stats.C) + '%';
  lblE.style.width = clamp(state.stats.E) + '%';
  lblT.style.width = clamp(state.stats.T) + '%';
}
function addInv(id, amt=1){
  const it=state.inv.find(i=>i.id===id); if(!it) return;
  it.have = (it.have||0)+amt; renderInvBar(); toast('ç²å¾—ï¼š'+it.name+' Ã—'+amt)
}
function renderInvBar(){
  invRow.innerHTML = '';
  let cnt=0;
  state.inv.forEach(it=>{
    cnt += (it.have||0)>0?1:0;
    const el=document.createElement('div'); el.className='invItem'; el.title=it.name;
    el.innerHTML=`<img src="${it.img}" alt=""><b>${it.have||0}</b>`;
    el.addEventListener('click',()=>{ playSfx(); openStoreModal(it.id); });
    invRow.appendChild(el);
  });
  invCount.textContent = cnt;
}
function applyEff(eff){
  if(!eff) return;
  state.stats.C += eff.C||0;
  state.stats.E += eff.E||0;
  state.stats.T += eff.T||0;
  syncBars();
}

/* ---------- å°è©±æ’­æ”¾ï¼ˆæœ€å¾Œæ‰é¡¯ç¤ºä¸‰é¸ä¸€ï¼Œç½®ä¸­ï¼‰ ---------- */
let idx=0; const who=document.getElementById('who'), line=document.getElementById('line'), ava=document.getElementById('ava');
function showLine(o){
  who.textContent=o.n; line.textContent=o.t; if(o.a) ava.src=o.a;
  if(o.stop){
    // æœ€å¾Œä¸€è¡Œæ‰é¡¯ç¤ºï¼Œç½®ä¸­ç™»å ´
    setTimeout(()=>{ document.getElementById('actionsDock').style.display='flex'; }, 800);
  }
}
function nextLine(){
  playSfx();
  const list=state.script;
  if(idx < list.length){ const o=list[idx++]; showLine(o); }
}
document.getElementById('next').onclick=()=>{ nextLine(); }
document.getElementById('auto').onclick=()=>{ state.auto=!state.auto; playSfx(); if(state.auto) autoplay(); }
function autoplay(){ if(!state.auto) return; nextLine(); setTimeout(()=>autoplay(), 2300); }

/* ---------- ä¸‰åˆ†æ”¯ ---------- */
document.querySelectorAll('#actionsDock .act').forEach(b=>{
  b.addEventListener('click', ()=>{
    playSfx();
    document.getElementById('actionsDock').style.display='none';
    const key=b.dataset.goto, seq=state.branches[key]||[];
    let i=0;
    const tick=()=>{
      if(i>=seq.length) return;
      const o=seq[i++]; showLine(o);
      if(o.act) o.act();
      if(o.link){
        setTimeout(()=>{ window.location.href=o.link; }, 900);
      }else setTimeout(tick, 1200);
    };
    tick();
  });
});

/* ---------- è¡£æ«ƒï¼ˆå½±ç‰‡å„ªå…ˆï¼‰ ---------- */
async function buildWardrobe(){
  wardrobeGrid.innerHTML='';
  for(const w of state.wardrobe){
    const card=document.createElement('div'); card.className='card';
    const media=document.createElement('div'); media.className='media';
    const mp4 = `assets/wardrobe/${w.id}.mp4`;
    const jpg = `assets/wardrobe/${w.id}.jpg`;
    let hasVideo=false;
    try{
      const r = await fetch(mp4,{method:'HEAD'}); hasVideo = r.ok;
    }catch{}
    if(hasVideo){
      media.innerHTML = `<video src="${mp4}" autoplay loop muted playsinline webkit-playsinline></video>`;
    }else{
      media.innerHTML = `<img src="${jpg}" alt="">`;
    }
    const h4=document.createElement('h4'); h4.textContent=w.title;
    const p=document.createElement('p'); p.className='muted';
    p.textContent = `æ•ˆæœ / Effectï¼š${w.eff.C?`å‹‡æ°£ +${w.eff.C} `:''}${w.eff.E?`åŒç† +${w.eff.E} `:''}${w.eff.T?`çœŸå¯¦ +${w.eff.T} `:''}`.trim();
    const row=document.createElement('div'); row.className='row';
    const wear=document.createElement('button'); wear.className='btn'; wear.textContent='ç©¿ä¸Š / Equip';
    wear.onclick=()=>{ playSfx(); applyEff(w.eff); toast('å·²ç©¿ä¸Šï¼š'+w.title); }
    row.appendChild(wear);
    card.append(media,h4,p,row);
    wardrobeGrid.appendChild(card);
  }
}

/* ---------- é“å…·åº«ï¼ˆé¢æ¿ï¼‰ + å•†åº—å°æµ ---------- */
function openStoreModal(focusId){
  playSfx();
  const modal=document.getElementById('store'); modal.classList.add('show');
  const full = modal.dataset.storeUrl || 'store.html';
  document.getElementById('goStoreFull').href = full + '?from=mission_snow_temple';
  storeGrid.innerHTML='';
  state.inv.forEach(it=>{
    const card=document.createElement('div'); card.className='storeCard';
    card.innerHTML = `
      <div class="storeHero"><img src="${it.img}" alt=""></div>
      <div>
        <h4 style="margin:6px 0">${it.name} <span class="muted">æŒæœ‰ x${it.have||0}</span></h4>
        <p class="muted">${it.desc||''}</p>
        <div class="chips">
          ${it.eff?.C?`<span class="chipSmall">å‹‡æ°£ +${it.eff.C}</span>`:''}
          ${it.eff?.E?`<span class="chipSmall">åŒç† +${it.eff.E}</span>`:''}
          ${it.eff?.T?`<span class="chipSmall">çœŸå¯¦ +${it.eff.T}</span>`:''}
        </div>
        <div class="rowR">
          <button class="btn useBtn">ä½¿ç”¨ / Use</button>
          <button class="btn">æ¦‚è¿°</button>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end;justify-content:flex-end">
        <a class="btn" target="_blank" href="${(document.getElementById('store').dataset.storeUrl||'store.html')}?buy=${it.id}">å‰å¾€è³¼è²·</a>
      </div>
    `;
    card.querySelector('.useBtn').onclick=()=>{
      playSfx();
      if((it.have||0)<=0){ toast('æ²’æœ‰å­˜è²¨ï¼Œè«‹å…ˆåˆ°å•†åº—è³¼è²·'); return; }
      it.have--; renderInvBar(); applyEff(it.eff); toast('å·²ä½¿ç”¨ï¼š'+it.name);
    };
    storeGrid.appendChild(card);
  });
}
document.getElementById('openStore').onclick=()=>openStoreModal();

/* ---------- äº‹ä»¶ç¹«çµ ---------- */
document.getElementById('wardrobeBtn').onclick=()=>{ buildWardrobe().then(()=>{ document.getElementById('wardrobe').classList.add('show'); playSfx(); }); };
document.getElementById('storeBtn').onclick=()=>openStoreModal();
document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',()=>{ playSfx(); document.querySelector(b.getAttribute('data-close')).classList.remove('show'); }));
document.querySelectorAll('.chip, .btn').forEach(b=>b.addEventListener('mousedown',playSfx));
document.querySelectorAll('[data-jump]').forEach(b=>b.addEventListener('click',()=>{ const to=b.dataset.jump; if(to) window.location.href=to; }));
document.getElementById('bgm').onclick=()=>{
  playSfx();
  if(BGM.paused){ BGM.volume=.6; BGM.play(); document.getElementById('bgm').textContent='BGMï¼šé–‹'; }
  else{ BGM.pause(); document.getElementById('bgm').textContent='BGMï¼šé—œ'; }
};

/* ---------- å•Ÿå‹• ---------- */
syncBars();
renderInvBar();
nextLine(); // é¡¯ç¤ºç¬¬ä¸€å¥
ensureBGVideo(); // â† ç¢ºä¿èƒŒæ™¯å½±ç‰‡å¯æ’­æ”¾ï¼ˆå«äº’å‹•è§£é–ï¼‰

try{ BGM.volume=.6; BGM.play(); document.getElementById('bgm').textContent='BGMï¼šé–‹'; }catch{}
</script>
</body>
</html>
